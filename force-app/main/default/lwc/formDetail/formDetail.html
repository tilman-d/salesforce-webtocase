<template>
    <!-- Loading Spinner -->
    <template if:true={isLoading}>
        <div class="slds-is-relative slds-p-around_large">
            <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
        </div>
    </template>

    <template if:false={isLoading}>
        <div class="slds-p-around_medium">
            <!-- Header -->
            <div class="slds-page-header slds-m-bottom_medium">
                <div class="slds-page-header__row">
                    <div class="slds-page-header__col-title">
                        <div class="slds-page-header__name">
                            <div class="slds-page-header__name-title">
                                <h1>
                                    <span class="slds-page-header__title slds-truncate">{pageTitle}</span>
                                </h1>
                            </div>
                        </div>
                    </div>
                    <div class="slds-page-header__col-actions">
                        <div class="slds-page-header__controls">
                            <div class="slds-page-header__control">
                                <lightning-button
                                    label="Cancel"
                                    onclick={handleCancel}>
                                </lightning-button>
                            </div>
                            <div class="slds-page-header__control">
                                <lightning-button
                                    label="View Live"
                                    icon-name="utility:new_window"
                                    onclick={handleViewLive}
                                    disabled={isNewForm}>
                                </lightning-button>
                            </div>
                            <div class="slds-page-header__control">
                                <lightning-button
                                    label="Save"
                                    variant="brand"
                                    onclick={handleSave}
                                    disabled={isSaving}>
                                    <template if:true={isSaving}>
                                        <lightning-spinner alternative-text="Saving" size="small" class="slds-m-left_x-small"></lightning-spinner>
                                    </template>
                                </lightning-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Settings Section -->
            <lightning-accordion allow-multiple-sections-open active-section-name={activeSections}>
                <lightning-accordion-section name="settings" label="Form Settings">
                    <div class="slds-grid slds-wrap slds-gutters">
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-p-bottom_small">
                            <lightning-input
                                label="Form Name"
                                value={form.formName}
                                onchange={handleFormNameChange}
                                required
                                placeholder="my-form-name"
                                field-level-help="URL-friendly identifier. Use lowercase letters, numbers, and hyphens only."
                                message-when-value-missing="Form Name is required">
                            </lightning-input>
                            <template if:true={formNameError}>
                                <div class="slds-text-color_error slds-text-body_small slds-m-top_xx-small">
                                    {formNameError}
                                </div>
                            </template>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-p-bottom_small">
                            <lightning-input
                                label="Title"
                                value={form.title}
                                onchange={handleTitleChange}
                                required
                                placeholder="Contact Us"
                                message-when-value-missing="Title is required">
                            </lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-p-bottom_small">
                            <lightning-textarea
                                label="Description"
                                value={form.description}
                                onchange={handleDescriptionChange}
                                placeholder="Instructions or description shown at the top of the form">
                            </lightning-textarea>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-p-bottom_small">
                            <lightning-textarea
                                label="Success Message"
                                value={form.successMessage}
                                onchange={handleSuccessMessageChange}
                                placeholder="Thank you for your submission!">
                            </lightning-textarea>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-p-bottom_small">
                            <lightning-input
                                type="checkbox"
                                label="Active"
                                checked={form.active}
                                onchange={handleActiveChange}>
                            </lightning-input>
                        </div>
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-p-bottom_small">
                            <lightning-input
                                type="checkbox"
                                label="Enable File Upload"
                                checked={form.enableFileUpload}
                                onchange={handleFileUploadChange}>
                            </lightning-input>
                            <template if:true={form.enableFileUpload}>
                                <p class="slds-text-color_weak slds-text-body_small slds-m-top_x-small">
                                    Images: Up to 25MB (auto-compressed) | Other Files: Up to 4MB
                                </p>
                            </template>
                        </div>
                        <template if:true={showCaptchaToggle}>
                        <div class="slds-col slds-size_1-of-1 slds-p-bottom_small slds-p-top_small">
                            <lightning-input
                                type="checkbox"
                                label="Enable CAPTCHA"
                                checked={form.enableCaptcha}
                                onchange={handleCaptchaChange}
                                field-level-help="Enable Google reCAPTCHA v2 to protect this form from spam and bot submissions. Requires reCAPTCHA keys to be configured in Custom Settings.">
                            </lightning-input>
                        </div>
                        </template>

                        <!-- Site Selection -->
                        <div class="slds-col slds-size_1-of-1 slds-p-bottom_small slds-p-top_medium">
                            <lightning-combobox
                                name="site"
                                label="Site"
                                placeholder="Select a Site"
                                options={siteOptions}
                                value={effectiveSiteId}
                                onchange={handleSiteChange}
                                field-level-help="Select the Site for this form's public URL.">
                            </lightning-combobox>
                        </div>

                        <!-- Public URL Display -->
                        <div class="slds-col slds-size_1-of-1 slds-p-bottom_small slds-p-top_medium">
                            <template if:true={computedPublicUrl}>
                                <div class="slds-form-element">
                                    <label class="slds-form-element__label">Public URL</label>
                                    <div class="slds-form-element__control">
                                        <div class="slds-grid slds-gutters_x-small">
                                            <div class="slds-col slds-grow">
                                                <lightning-input
                                                    type="text"
                                                    value={computedPublicUrl}
                                                    readonly
                                                    variant="label-hidden">
                                                </lightning-input>
                                            </div>
                                            <div class="slds-col slds-no-flex">
                                                <lightning-button-icon
                                                    icon-name="utility:copy"
                                                    alternative-text="Copy URL"
                                                    title="Copy URL"
                                                    onclick={handleCopyUrl}>
                                                </lightning-button-icon>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <template if:false={computedPublicUrl}>
                                <template if:false={hasDefaultSite}>
                                    <div class="slds-form-element">
                                        <label class="slds-form-element__label">Public URL</label>
                                        <div class="slds-form-element__control">
                                            <p class="slds-text-color_weak slds-p-top_xx-small">
                                                <lightning-icon icon-name="utility:warning" size="x-small" class="slds-m-right_xx-small"></lightning-icon>
                                                No default Site configured. Run the Setup Wizard first.
                                            </p>
                                        </div>
                                    </div>
                                </template>
                                <template if:true={hasDefaultSite}>
                                    <template if:false={form.formName}>
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">Public URL</label>
                                            <div class="slds-form-element__control">
                                                <p class="slds-text-color_weak slds-p-top_xx-small">
                                                    Enter a Form Name to see the public URL.
                                                </p>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                            </template>
                        </div>
                    </div>
                </lightning-accordion-section>

                <!-- Fields Section -->
                <lightning-accordion-section name="fields" label="Form Fields">
                    <div class="slds-m-bottom_small">
                        <lightning-button
                            label="Add Field"
                            variant="neutral"
                            icon-name="utility:add"
                            onclick={handleAddField}>
                        </lightning-button>
                    </div>

                    <template if:false={hasFields}>
                        <div class="slds-illustration slds-illustration_small slds-p-around_medium slds-text-align_center">
                            <p class="slds-text-body_regular">No fields yet. Click "Add Field" to create your first field.</p>
                        </div>
                    </template>

                    <template if:true={hasFields}>
                        <div class="field-list">
                            <template for:each={fieldsWithIndex} for:item="field">
                                <div key={field.tempId} class="field-item slds-box slds-m-bottom_small">
                                    <!-- Field Header (always visible) -->
                                    <div class="field-header slds-grid slds-grid_align-spread slds-grid_vertical-align-center">
                                        <div class="slds-col slds-grow">
                                            <button
                                                type="button"
                                                class="slds-button slds-button_reset field-toggle"
                                                data-index={field.index}
                                                onclick={handleToggleField}>
                                                <lightning-icon
                                                    icon-name={field.chevronIcon}
                                                    size="x-small"
                                                    class="slds-m-right_x-small">
                                                </lightning-icon>
                                                <span class="slds-text-body_regular">
                                                    <strong>{field.displayIndex}.</strong>
                                                    {field.fieldLabel}
                                                    <template if:false={field.fieldLabel}>
                                                        <em class="slds-text-color_weak">(New Field)</em>
                                                    </template>
                                                </span>
                                                <span class="slds-badge slds-m-left_small">{field.fieldType}</span>
                                                <template if:true={field.required}>
                                                    <span class="slds-badge slds-badge_inverse slds-m-left_x-small">Required</span>
                                                </template>
                                            </button>
                                        </div>
                                        <div class="slds-col slds-no-flex">
                                            <lightning-button-group>
                                                <lightning-button-icon
                                                    icon-name="utility:up"
                                                    alternative-text="Move Up"
                                                    data-index={field.index}
                                                    onclick={handleMoveFieldUp}
                                                    disabled={field.isFirst}>
                                                </lightning-button-icon>
                                                <lightning-button-icon
                                                    icon-name="utility:down"
                                                    alternative-text="Move Down"
                                                    data-index={field.index}
                                                    onclick={handleMoveFieldDown}
                                                    disabled={field.isLast}>
                                                </lightning-button-icon>
                                                <lightning-button-icon
                                                    icon-name="utility:delete"
                                                    alternative-text="Delete"
                                                    variant="destructive"
                                                    data-index={field.index}
                                                    onclick={handleDeleteField}>
                                                </lightning-button-icon>
                                            </lightning-button-group>
                                        </div>
                                    </div>

                                    <!-- Field Details (expanded) -->
                                    <template if:true={field.isExpanded}>
                                        <div class="field-details slds-p-top_small slds-border_top slds-m-top_small">
                                            <div class="slds-grid slds-wrap slds-gutters">
                                                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-p-bottom_small">
                                                    <lightning-input
                                                        label="Field Label"
                                                        value={field.fieldLabel}
                                                        data-index={field.index}
                                                        onchange={handleFieldLabelChange}
                                                        required
                                                        placeholder="Your Name">
                                                    </lightning-input>
                                                </div>
                                                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-p-bottom_small">
                                                    <lightning-combobox
                                                        label="Field Type"
                                                        value={field.fieldType}
                                                        options={fieldTypeOptions}
                                                        data-index={field.index}
                                                        onchange={handleFieldTypeChange}
                                                        required>
                                                    </lightning-combobox>
                                                </div>
                                                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-p-bottom_small">
                                                    <lightning-combobox
                                                        label="Maps to Case Field"
                                                        value={field.caseField}
                                                        options={caseFieldOptions}
                                                        data-index={field.index}
                                                        onchange={handleCaseFieldChange}
                                                        required>
                                                    </lightning-combobox>
                                                </div>
                                                <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-p-bottom_small slds-p-top_medium">
                                                    <lightning-input
                                                        type="checkbox"
                                                        label="Required"
                                                        checked={field.required}
                                                        data-index={field.index}
                                                        onchange={handleRequiredChange}>
                                                    </lightning-input>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </lightning-accordion-section>

                <!-- Default Case Values Section -->
                <lightning-accordion-section name="defaults" label="Default Case Values">
                    <div class="defaults-section">
                        <p class="slds-text-color_weak slds-text-body_small slds-m-bottom_small">
                            Set default values for hidden Case fields. These are applied automatically when a case is created from this form.
                            Note: If a picklist value becomes invalid, the system will still create the case without defaults.
                        </p>

                        <div class="slds-m-bottom_small">
                            <lightning-button
                                label="Add Default Value"
                                variant="neutral"
                                icon-name="utility:add"
                                onclick={handleAddDefault}
                                disabled={cannotAddDefault}>
                            </lightning-button>
                        </div>

                        <template if:false={hasDefaultValues}>
                            <div class="slds-illustration slds-illustration_small slds-p-around_medium slds-text-align_center">
                                <p class="slds-text-body_regular">No default values configured. Click "Add Default Value" to set hidden Case field defaults.</p>
                            </div>
                        </template>

                        <template if:true={hasDefaultValues}>
                            <template for:each={defaultValuesWithIndex} for:item="dv">
                                <div key={dv.tempId} class="slds-grid slds-gutters slds-grid_vertical-align-end slds-m-bottom_small">
                                    <div class="slds-col slds-size_5-of-12">
                                        <lightning-combobox
                                            label="Case Field"
                                            value={dv.fieldName}
                                            options={dv.fieldOptions}
                                            data-index={dv.index}
                                            onchange={handleDefaultFieldChange}
                                            placeholder="Select a field">
                                        </lightning-combobox>
                                    </div>
                                    <div class="slds-col slds-size_5-of-12">
                                        <template if:true={dv.isPicklist}>
                                            <lightning-combobox
                                                label="Value"
                                                value={dv.value}
                                                options={dv.picklistOptions}
                                                data-index={dv.index}
                                                onchange={handleDefaultValueChange}
                                                placeholder="Select a value">
                                            </lightning-combobox>
                                        </template>
                                        <template if:false={dv.isPicklist}>
                                            <lightning-input
                                                label="Value"
                                                value={dv.value}
                                                data-index={dv.index}
                                                onchange={handleDefaultValueChange}
                                                placeholder="Enter value">
                                            </lightning-input>
                                        </template>
                                    </div>
                                    <div class="slds-col slds-size_2-of-12">
                                        <lightning-button-icon
                                            icon-name="utility:delete"
                                            alternative-text="Remove"
                                            variant="destructive"
                                            data-index={dv.index}
                                            onclick={handleRemoveDefault}>
                                        </lightning-button-icon>
                                    </div>
                                </div>
                            </template>
                        </template>
                    </div>
                </lightning-accordion-section>

                <!-- Embed Code Section -->
                <lightning-accordion-section name="embed" label="Embed Code">
                    <template if:true={isNewForm}>
                        <div class="slds-illustration slds-illustration_small slds-p-around_medium slds-text-align_center">
                            <p class="slds-text-body_regular">Save the form first to generate embed code.</p>
                        </div>
                    </template>

                    <template if:false={isNewForm}>
                        <!-- Allowed Domains (applies to all embed methods) -->
                        <div class="slds-p-bottom_medium">
                            <lightning-textarea
                                label="Allowed Domains (one per line)"
                                value={form.allowedDomains}
                                onchange={handleAllowedDomainsChange}
                                placeholder="example.com&#10;mysite.org"
                                field-level-help="Enter domain names that are allowed to embed this form. Leave empty to disable external embedding.">
                            </lightning-textarea>
                            <p class="slds-text-color_weak slds-text-body_small slds-m-top_x-small">
                                Enter only the domain (e.g., example.com), not the full URL. One domain per line.
                            </p>
                            <div class="slds-m-top_small">
                                <lightning-button
                                    label="Generate Embed Code"
                                    variant="brand"
                                    icon-name="utility:preview"
                                    onclick={handleConfirmDomains}
                                    disabled={confirmDomainsDisabled}>
                                </lightning-button>
                            </div>
                        </div>

                        <!-- reCAPTCHA Warning (applies to all embed methods) -->
                        <template if:true={form.enableCaptcha}>
                            <div class="slds-p-bottom_medium">
                                <div class="slds-scoped-notification slds-media slds-media_center slds-theme_warning" role="status">
                                    <div class="slds-media__figure">
                                        <lightning-icon icon-name="utility:warning" size="small"></lightning-icon>
                                    </div>
                                    <div class="slds-media__body">
                                        <p>
                                            <strong>reCAPTCHA Setup Required:</strong> Add your embedding domain to your
                                            <a href="https://www.google.com/recaptcha/admin" target="_blank" rel="noopener">Google reCAPTCHA allowed domains list</a>.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <template if:true={showEmbedCode}>
                            <!-- Scoped tabs -->
                            <div class="slds-tabs_scoped">
                                <ul class="slds-tabs_scoped__nav" role="tablist">
                                    <li class={widgetTabClass} role="presentation">
                                        <a class="slds-tabs_scoped__link" role="tab" data-tab="widget" onclick={handleEmbedTabClick}>Widget</a>
                                    </li>
                                    <li class={customHtmlTabClass} role="presentation">
                                        <a class="slds-tabs_scoped__link" role="tab" data-tab="customhtml" onclick={handleEmbedTabClick}>Custom HTML</a>
                                    </li>
                                    <li class={iframeTabClass} role="presentation">
                                        <a class="slds-tabs_scoped__link" role="tab" data-tab="iframe" onclick={handleEmbedTabClick}>iframe</a>
                                    </li>
                                </ul>

                                <!-- Tab 1: Widget -->
                                <template if:true={isWidgetTab}>
                                    <div class="slds-tabs_scoped__content slds-show" role="tabpanel">
                                        <div class="slds-p-around_small">
                                            <div class="slds-p-bottom_medium">
                                                <div class="slds-text-title_bold slds-m-bottom_x-small">1. Add this script to your website:</div>
                                                <div class="slds-box slds-box_x-small slds-theme_shade embed-code-box">
                                                    <pre class="embed-code">{embedScriptSnippet}</pre>
                                                </div>
                                                <div class="slds-m-top_x-small">
                                                    <lightning-button
                                                        label="Copy Code"
                                                        icon-name="utility:copy"
                                                        onclick={handleCopyScriptCode}>
                                                    </lightning-button>
                                                </div>
                                            </div>

                                            <div class="slds-p-bottom_medium">
                                                <div class="slds-text-title_bold slds-m-bottom_x-small">2. (Optional) Customize styling with CSS variables:</div>
                                                <div class="slds-box slds-box_x-small slds-theme_shade embed-code-box">
                                                    <pre class="embed-code">{embedStyleSnippet}</pre>
                                                </div>
                                                <div class="slds-m-top_x-small">
                                                    <lightning-button
                                                        label="Copy Code"
                                                        icon-name="utility:copy"
                                                        onclick={handleCopyStyleCode}>
                                                    </lightning-button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <!-- Tab 2: Custom HTML -->
                                <template if:true={isCustomHtmlTab}>
                                    <div class="slds-tabs_scoped__content slds-show" role="tabpanel">
                                        <div class="slds-p-around_small">
                                            <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_medium">
                                                Build your own form HTML with full design control. The script handles validation, submission, file uploads, and CAPTCHA automatically.
                                            </p>

                                            <div class="slds-p-bottom_medium">
                                                <div class="slds-text-title_bold slds-m-bottom_x-small">1. Add the form HTML:</div>
                                                <div class="slds-box slds-box_x-small slds-theme_shade embed-code-box">
                                                    <pre class="embed-code">{customHtmlSnippet}</pre>
                                                </div>
                                                <div class="slds-m-top_x-small">
                                                    <lightning-button
                                                        label="Copy HTML"
                                                        icon-name="utility:copy"
                                                        onclick={handleCopyCustomHtml}>
                                                    </lightning-button>
                                                </div>
                                            </div>

                                            <div class="slds-p-bottom_medium">
                                                <div class="slds-text-title_bold slds-m-bottom_x-small">2. (Optional) Add starter styles:</div>
                                                <div class="slds-box slds-box_x-small slds-theme_shade embed-code-box">
                                                    <pre class="embed-code">{customCssSnippet}</pre>
                                                </div>
                                                <div class="slds-m-top_x-small">
                                                    <lightning-button
                                                        label="Copy CSS"
                                                        icon-name="utility:copy"
                                                        onclick={handleCopyCustomCss}>
                                                    </lightning-button>
                                                </div>
                                            </div>

                                            <div class="slds-p-bottom_medium">
                                                <div class="slds-text-title_bold slds-m-bottom_x-small">3. Add the connect script:</div>
                                                <div class="slds-box slds-box_x-small slds-theme_shade embed-code-box">
                                                    <pre class="embed-code">{customJsSnippet}</pre>
                                                </div>
                                                <div class="slds-m-top_x-small">
                                                    <lightning-button
                                                        label="Copy JavaScript"
                                                        icon-name="utility:copy"
                                                        onclick={handleCopyCustomJs}>
                                                    </lightning-button>
                                                </div>
                                            </div>

                                            <div class="slds-scoped-notification slds-media slds-media_center slds-theme_info" role="status">
                                                <div class="slds-media__figure">
                                                    <lightning-icon icon-name="utility:info" size="small"></lightning-icon>
                                                </div>
                                                <div class="slds-media__body">
                                                    <p>
                                                        Input <code>name</code> attributes must match Case field API names.
                                                        You can rearrange, add classes, and style freely.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <!-- Tab 3: iframe -->
                                <template if:true={isIframeTab}>
                                    <div class="slds-tabs_scoped__content slds-show" role="tabpanel">
                                        <div class="slds-p-around_small">
                                            <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_x-small">
                                                Use iframe if you need full DOM isolation or have CSP restrictions.
                                            </p>
                                            <div class="slds-box slds-box_x-small slds-theme_shade embed-code-box">
                                                <pre class="embed-code">{embedIframeSnippet}</pre>
                                            </div>
                                            <div class="slds-m-top_x-small">
                                                <lightning-button
                                                    label="Copy Code"
                                                    icon-name="utility:copy"
                                                    onclick={handleCopyIframeCode}>
                                                </lightning-button>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <template if:false={showEmbedCode}>
                            <div class="slds-illustration slds-illustration_small slds-p-around_medium slds-text-align_center">
                                <p class="slds-text-body_regular">Enter allowed domains above and click "Generate Embed Code" to view embed snippets.</p>
                            </div>
                        </template>
                    </template>
                </lightning-accordion-section>
            </lightning-accordion>
        </div>
    </template>
</template>
